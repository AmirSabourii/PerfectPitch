# File Upload GPT-4o-mini System - Implementation Guide

## Overview
سیستم آپلود فایل به طور کامل بازنویسی شد تا از GPT-4o-mini برای خواندن مستقیم PDF و استخراج اطلاعات ساختاریافته استفاده کند.

## تغییرات اصلی

### 1. API Parse-Doc (`app/api/parse-doc/route.ts`)
**قبل:** از `pdf-parse` برای استخراج متن ساده استفاده می‌کرد
**بعد:** از GPT-4o-mini برای تحلیل کامل PDF استفاده می‌کند

#### ویژگی‌های جدید:
- ✅ تحلیل تصاویر، جداول، نمودارها و دیاگرام‌ها
- ✅ استخراج ساختاریافته اطلاعات در قالب JSON
- ✅ ارسال مستقیم PDF به GPT-4o-mini (به صورت base64)
- ✅ محدودیت حجم فایل: 20MB
- ✅ هزینه بسیار کمتر نسبت به GPT-4o

#### نحوه کار:
1. PDF به base64 تبدیل می‌شود
2. به همراه system prompt به GPT-4o-mini ارسال می‌شود
3. GPT-4o-mini تمام محتوا (متن، تصاویر، جداول) را می‌خواند
4. اطلاعات را به صورت JSON ساختاریافته برمی‌گرداند

#### خروجی JSON:
```json
{
  "problem": "مشکلی که حل می‌کند",
  "solution": "راه‌حل ارائه شده",
  "market": "اندازه بازار و مشتری هدف",
  "competitors": "رقبا و مزیت رقابتی",
  "businessModel": "مدل درآمدی",
  "traction": "جذب و رشد",
  "team": "تیم و تخصص‌ها",
  "financials": "اطلاعات مالی",
  "ask": "درخواست سرمایه",
  "stage": "مرحله شرکت",
  "industry": "صنعت",
  "additionalInfo": "اطلاعات اضافی"
}
```

### 2. کامپوننت ExtractedDataReview (`components/ExtractedDataReview.tsx`)
کامپوننت جدید برای نمایش و ویرایش اطلاعات استخراج شده

#### ویژگی‌ها:
- ✅ نمایش تمام فیلدهای استخراج شده
- ✅ حالت View و Edit
- ✅ هشدار برای بررسی دقت اطلاعات
- ✅ امکان ویرایش هر فیلد
- ✅ دکمه‌های Confirm و Cancel

### 3. AudioRecorder Component (`components/AudioRecorder.tsx`)
#### تغییرات:
- ✅ اضافه شدن callback `onFileProcessed`
- ✅ ذخیره داده‌های استخراج شده به صورت JSON
- ✅ حذف دکمه "Start Analysis" (خودکار به review می‌رود)
- ✅ نمایش وضعیت "Analyzing your pitch deck..."

### 4. DashboardContext (`contexts/DashboardContext.tsx`)
#### تغییرات:
- ✅ اضافه شدن state `extractedData`
- ✅ اضافه شدن setter `setExtractedData`
- ✅ پاکسازی extractedData در resetDashboard

### 5. DashboardContent (`components/dashboard/DashboardContent.tsx`)
#### تغییرات:
- ✅ اضافه شدن phase جدید: `data_review`
- ✅ تابع `handleFileProcessed`: دریافت داده‌های استخراج شده
- ✅ تابع `handleDataConfirm`: تبدیل داده‌ها به فرمت متنی و شروع تحلیل
- ✅ نمایش کامپوننت ExtractedDataReview در phase جدید

### 6. Types (`lib/types.ts`)
#### تغییرات:
- ✅ اضافه شدن `data_review` به Phase type

## جریان کار جدید

```
1. کاربر PDF آپلود می‌کند
   ↓
2. Frontend → /api/parse-doc (FormData با فایل PDF)
   ↓
3. Backend: PDF به base64 تبدیل می‌شود
   ↓
4. Backend → GPT-4o-mini API (با PDF در base64)
   - تحلیل کامل PDF (متن، تصاویر، جداول، نمودارها)
   - استخراج اطلاعات ساختاریافته
   ↓
5. Backend → Frontend: JSON با اطلاعات استخراج شده
   ↓
6. Frontend: نمایش ExtractedDataReview
   - کاربر اطلاعات را بررسی می‌کند
   - در صورت نیاز ویرایش می‌کند
   ↓
7. کاربر "Confirm & Analyze" می‌زند
   ↓
8. اطلاعات به فرمت متنی تبدیل می‌شود
   ↓
9. شروع تحلیل Stage 1, 2, 3
```

## مزایای سیستم جدید

### 1. دقت بالاتر
- ✅ تحلیل تصاویر و نمودارها
- ✅ درک بهتر از محتوای بصری
- ✅ استخراج اطلاعات از جداول پیچیده

### 2. کنترل کاربر
- ✅ بررسی اطلاعات قبل از تحلیل
- ✅ ویرایش اطلاعات نادرست
- ✅ شفافیت کامل در فرآیند

### 3. ساختار بهتر
- ✅ داده‌های ساختاریافته
- ✅ فیلدهای مشخص و قابل استفاده
- ✅ آماده برای تحلیل Stage 1, 2, 3

### 4. تجربه کاربری بهتر
- ✅ فیدبک واضح در هر مرحله
- ✅ امکان اصلاح اشتباهات
- ✅ اطمینان از دقت قبل از تحلیل

## هزینه‌ها

### GPT-4o-mini API:
- Input: $0.150 per 1M tokens (16x ارزان‌تر از GPT-4o)
- Output: $0.600 per 1M tokens (16x ارزان‌تر از GPT-4o)

### تخمین هزینه برای هر PDF:
- PDF 10 صفحه‌ای: ~$0.002 - $0.005 (کمتر از نیم سنت!)
- PDF 20 صفحه‌ای: ~$0.004 - $0.010 (حدود یک سنت)

### مقایسه هزینه:
| مدل | PDF 10 صفحه | PDF 20 صفحه |
|-----|-------------|-------------|
| pdf-parse | رایگان | رایگان |
| GPT-4o-mini | ~$0.003 | ~$0.007 |
| GPT-4o | ~$0.05 | ~$0.10 |

**نتیجه:** GPT-4o-mini تقریباً 16 برابر ارزان‌تر از GPT-4o است و همان قابلیت خواندن PDF را دارد!

## محدودیت‌ها

1. **حجم فایل:** حداکثر 20MB
2. **تعداد صفحات:** بدون محدودیت (اما هزینه افزایش می‌یابد)
3. **زمان پردازش:** 30-60 ثانیه برای PDF معمولی
4. **دقت:** 90-95% (نیاز به بررسی کاربر)

## نکات مهم

### برای توسعه‌دهندگان:
1. حتماً `OPENAI_API_KEY` را در `.env.local` تنظیم کنید
2. timeout ها را برای فایل‌های بزرگ افزایش دهید
3. خطاها را به درستی handle کنید

### برای کاربران:
1. همیشه اطلاعات استخراج شده را بررسی کنید
2. اطلاعات نادرست را ویرایش کنید
3. فایل‌های کوچکتر سریعتر پردازش می‌شوند

## تست

برای تست سیستم:
1. یک PDF pitch deck آماده کنید
2. در dashboard روی "File Only" کلیک کنید
3. PDF را آپلود کنید
4. منتظر بمانید تا اطلاعات استخراج شود
5. اطلاعات را بررسی و در صورت نیاز ویرایش کنید
6. روی "Confirm & Analyze" کلیک کنید
7. منتظر نتایج تحلیل Stage 1, 2, 3 باشید

## مشکلات احتمالی و راه‌حل

### 1. خطای "Failed to parse document"
- **علت:** فایل خراب یا فرمت نامعتبر
- **راه‌حل:** فایل PDF معتبر آپلود کنید

### 2. خطای "Document analysis timed out"
- **علت:** فایل خیلی بزرگ است
- **راه‌حل:** فایل کوچکتر آپلود کنید یا timeout را افزایش دهید

### 3. اطلاعات استخراج شده نادرست
- **علت:** محدودیت‌های AI در درک محتوا
- **راه‌حل:** اطلاعات را در صفحه review ویرایش کنید

### 4. خطای "Invalid JSON response"
- **علت:** مشکل در پاسخ GPT-4o
- **راه‌حل:** دوباره تلاش کنید یا فایل را بررسی کنید

## آینده

### بهبودهای پیشنهادی:
- [ ] پشتیبانی از فرمت‌های دیگر (PPTX, DOCX)
- [ ] ذخیره تاریخچه استخراج‌ها
- [ ] مقایسه نسخه‌های مختلف
- [ ] پیشنهاد خودکار بهبودها
- [ ] تحلیل تصاویر جداگانه
- [ ] OCR برای PDF های اسکن شده

## نتیجه‌گیری

این سیستم جدید دقت و کنترل بیشتری به کاربر می‌دهد و از قدرت GPT-4o Vision برای تحلیل کامل pitch deck استفاده می‌کند. با این تغییرات، کاربران می‌توانند اطمینان حاصل کنند که اطلاعات صحیح برای تحلیل استفاده می‌شود.
